.PHONY: help build deploy clean test

# Variables
ENVIRONMENT ?= prod
REGION ?= us-east-1
PROJECT_NAME = productsapp

help:
	@echo "Comandos disponibles:"
	@echo "  make build              - Construir im√°genes Docker localmente"
	@echo "  make push               - Publicar im√°genes a ECR"
	@echo "  make deploy-infra       - Desplegar infraestructura CloudFormation"
	@echo "  make deploy-lambda      - Actualizar funci√≥n Lambda"
	@echo "  make deploy-ec2         - Desplegar aplicaci√≥n EC2"
	@echo "  make deploy-all         - Desplegar todo (requiere EC2_KEY_NAME)"
	@echo "  make test-local         - Ejecutar con docker-compose localmente"
	@echo "  make clean              - Eliminar recursos AWS"
	@echo "  make logs-lambda        - Ver logs de Lambda"
	@echo ""
	@echo "Variables de entorno:"
	@echo "  ENVIRONMENT=${ENVIRONMENT}"
	@echo "  REGION=${REGION}"
	@echo "  EC2_KEY_NAME=${EC2_KEY_NAME}"

build:
	@echo "üê≥ Construyendo im√°genes Docker..."
	cd lambda && docker build -t productsapp-lambda:latest .
	cd ec2_app && docker build -t productsapp-ec2app:latest .

push:
	@echo "üì§ Publicando im√°genes a ECR..."
	./scripts/build-and-push.sh all $(ENVIRONMENT) $(REGION)

deploy-infra:
	@echo "üèóÔ∏è Desplegando infraestructura..."
	./scripts/deploy-infrastructure.sh $(ENVIRONMENT) $(REGION)

deploy-lambda:
	@echo "‚ö° Actualizando Lambda..."
	./scripts/update-lambda.sh $(ENVIRONMENT) $(REGION)

deploy-ec2:
	@echo "üñ•Ô∏è Desplegando EC2..."
	@if [ -z "$(EC2_KEY_NAME)" ]; then \
		echo "Error: Se requiere EC2_KEY_NAME"; \
		echo "Uso: make deploy-ec2 EC2_KEY_NAME=my-key"; \
		exit 1; \
	fi
	./scripts/deploy-ec2.sh $(ENVIRONMENT) $(REGION) $(EC2_KEY_NAME)

deploy-all:
	@echo "üöÄ Despliegue completo..."
	@if [ -z "$(EC2_KEY_NAME)" ]; then \
		echo "Error: Se requiere EC2_KEY_NAME"; \
		echo "Uso: make deploy-all EC2_KEY_NAME=my-key"; \
		exit 1; \
	fi
	./scripts/deploy-all.sh $(ENVIRONMENT) $(REGION) $(EC2_KEY_NAME)

test-local:
	@echo "üß™ Ejecutando localmente con Docker Compose..."
	docker-compose up --build

clean:
	@echo "üóëÔ∏è Eliminando recursos..."
	@read -p "¬øEst√°s seguro de eliminar todos los recursos? (y/n) " -n 1 -r; \
	echo; \
	if [[ $$REPLY =~ ^[Yy]$$ ]]; then \
		aws cloudformation delete-stack \
			--stack-name $(PROJECT_NAME)-$(ENVIRONMENT) \
			--region $(REGION); \
		echo "Stack elimin√°ndose..."; \
	fi

logs-lambda:
	@echo "üìã Logs de Lambda..."
	aws logs tail /aws/lambda/$(PROJECT_NAME)-api-$(ENVIRONMENT) --follow --region $(REGION)

api-url:
	@aws cloudformation describe-stacks \
		--stack-name $(PROJECT_NAME)-$(ENVIRONMENT) \
		--region $(REGION) \
		--query 'Stacks[0].Outputs[?OutputKey==`ApiGatewayUrl`].OutputValue' \
		--output text

test-api:
	@echo "üß™ Probando API..."
	@API_URL=$$(make api-url); \
	echo "Creando producto de prueba..."; \
	curl -X POST $$API_URL/products \
		-H "Content-Type: application/json" \
		-d '{"id":"test-001","name":"Test Product","description":"Test","price":99.99,"stock":10}'; \
	echo ""; \
	echo "Listando productos..."; \
	curl $$API_URL/products | jq
